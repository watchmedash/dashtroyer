<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anime Details</title>
  <link rel="stylesheet" href="anime.css">
</head>
<body>
  <header>
    <h1 id="anime-title"></h1>
  </header>

  <div id="anime-details" class="anime-details">
    <div id="anime-poster"></div>

    <div id="anime-seasons">
      <label for="season-dropdown">Select Season:</label>
      <select id="season-dropdown"></select>

      <label for="episode-dropdown">Select Episode:</label>
      <select id="episode-dropdown"></select>
    </div>

    <div id="anime-player">
      <iframe id="anime-player-frame" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const malId = urlParams.get('malid');

    async function fetchAnimeDetails(malId) {
      const response = await fetch(`https://api.myanimelist.net/v2/anime/${malId}`);
      const data = await response.json();
      return data; // Return anime details (title, poster, seasons, episodes)
    }

    async function populateAnimeDetails() {
      const animeDetails = await fetchAnimeDetails(malId);

      // Populate anime title and poster
      document.getElementById('anime-title').textContent = animeDetails.title;
      document.getElementById('anime-poster').innerHTML = `<img src="${animeDetails.images.jpg.large_image_url}" alt="${animeDetails.title}">`;

      // Populate season dropdown (if available)
      const seasonDropdown = document.getElementById('season-dropdown');
      animeDetails.seasons.forEach(season => {
        const option = document.createElement('option');
        option.value = season.number;
        option.textContent = `Season ${season.number}`;
        seasonDropdown.appendChild(option);
      });

      seasonDropdown.addEventListener('change', updateEpisodeDropdown);

      // Set the player iframe based on the first available season and episode
      const firstSeason = animeDetails.seasons[0];
      const firstEpisode = firstSeason.episodes[0];
      updateIframe(firstSeason.number, firstEpisode.number, 'sub');
    }

    function updateEpisodeDropdown() {
      const selectedSeason = document.getElementById('season-dropdown').value;
      const selectedSeasonData = animeDetails.seasons.find(season => season.number == selectedSeason);

      const episodeDropdown = document.getElementById('episode-dropdown');
      episodeDropdown.innerHTML = ''; // Clear previous options

      selectedSeasonData.episodes.forEach(episode => {
        const option = document.createElement('option');
        option.value = episode.number;
        option.textContent = `Episode ${episode.number}`;
        episodeDropdown.appendChild(option);
      });
    }

    function updateIframe(season, episode, subOrDub) {
      const iframe = document.getElementById('anime-player-frame');
      iframe.src = `https://vidlink.pro/anime/${malId}/${season}/${episode}/${subOrDub}?fallback=true`;
    }

    populateAnimeDetails();
  </script>
</body>
</html>
